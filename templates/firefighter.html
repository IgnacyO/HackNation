<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strażak - {{ firefighter_id }}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent: #495057;
            --danger: #dc3545;
            --danger-light: #ffe0e0;
            --warning: #ffc107;
            --warning-light: #fff8e0;
            --success: #28a745;
            --success-light: #e0f5e8;
            --info: #17a2b8;
            --info-light: #e0f4f8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .navbar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
        }

        .metric-card {
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .metric-card.warning {
            background: var(--warning-light);
            border-color: var(--warning);
        }

        .metric-card.critical {
            background: var(--danger-light);
            border-color: var(--danger);
        }

        .metric-card.normal {
            background: var(--success-light);
            border-color: var(--success);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-unit {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background: var(--success); }
        .status-offline { background: var(--danger); }
        .status-warning { background: var(--warning); }
        .status-danger { background: var(--danger); }

        .alert-item {
            padding: 0.75rem;
            border-left: 4px solid;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .alert-critical {
            border-left-color: var(--danger);
            background: #fff5f5;
        }

        .alert-warning {
            border-left-color: var(--warning);
            background: #fffbf0;
        }

        .heartbeat-animation {
            animation: heartbeat 1s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .battery-bar {
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .battery-fill {
            height: 100%;
            transition: width 0.3s ease, background-color 0.3s ease;
            border-radius: 10px;
        }

        .battery-high { background: var(--success); }
        .battery-medium { background: var(--warning); }
        .battery-low { background: var(--danger); }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-arrow-left me-2"></i>
                Powrót
            </a>
            <div class="ms-auto">
                <span class="text-muted">Strażak: <strong>{{ firefighter_id }}</strong></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row g-4">
            <!-- Left Column - Metrics -->
            <div class="col-lg-8">
                <!-- Vital Signs -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-heartbeat me-2"></i>Parametry życiowe
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <!-- Heart Rate -->
                            <div class="col-md-4">
                                <div class="metric-card" id="heart-rate-card">
                                    <div class="metric-label">Tętno</div>
                                    <div class="metric-value">
                                        <span id="heart-rate" class="heartbeat-animation">--</span>
                                        <span class="metric-unit">bpm</span>
                                    </div>
                                    <div class="small text-muted">Bicie serca</div>
                                </div>
                            </div>

                            <!-- Battery -->
                            <div class="col-md-4">
                                <div class="metric-card" id="battery-card">
                                    <div class="metric-label">Bateria</div>
                                    <div class="metric-value">
                                        <span id="battery-level">--</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="battery-bar mt-3">
                                        <div id="battery-fill" class="battery-fill" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- CO2 Level -->
                            <div class="col-md-4">
                                <div class="metric-card" id="co2-card">
                                    <div class="metric-label">CO₂ we krwi</div>
                                    <div class="metric-value">
                                        <span id="co2-level">--</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="small text-muted">Dwutlenek węgla</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-info-circle me-2"></i>Status
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>Stan ruchu:</strong>
                                    <span id="motion-status" class="ms-2">
                                        <span class="status-indicator status-online"></span>
                                        <span>Sprawdzanie...</span>
                                    </span>
                                </div>
                                <div>
                                    <strong>Bezruch:</strong>
                                    <span id="man-down-status" class="ms-2">
                                        <span class="status-indicator status-offline"></span>
                                        <span>Nie wykryto</span>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>Ostatnia aktualizacja:</strong>
                                    <div id="last-update" class="text-muted small">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-exclamation-triangle me-2"></i>Powiadomienia
                    </div>
                    <div class="card-body">
                        <div id="alerts-container">
                            <p class="text-muted text-center">Brak aktywnych powiadomień</p>
                        </div>
                    </div>
                </div>

                <!-- Heart Rate Chart -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i>Wykres tętna
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="heartRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Map -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-map-marker-alt me-2"></i>Pozycja
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                        <div class="mt-3">
                            <div class="small text-muted">
                                <strong>Współrzędne:</strong>
                                <div id="position-coords">--</div>
                            </div>
                            <div class="small text-muted mt-2">
                                <strong>Piętro:</strong>
                                <span id="position-floor">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const firefighterId = "{{ firefighter_id }}";
        const apiBaseUrl = "{{ api_base_url }}";
        const lat = parseFloat("{{ lat }}");
        const lon = parseFloat("{{ lon }}");
        const floorData = JSON.parse('{{ floor_data_json | safe }}');
        const cords = JSON.parse('{{ cords_json | safe }}');

            // Initialize map with higher zoom
            const map = L.map('map').setView([lat, lon], 20);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 22
            }).addTo(map);

        let firefighterMarker = null;

        // Heart rate chart
        const ctx = document.getElementById('heartRateChart').getContext('2d');
        const heartRateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Tętno (bpm)',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 50,
                        max: 200
                    }
                }
            }
        });

        // Update functions
        function updateTelemetry(data) {
            // Heart rate
            const heartRate = data.vitals?.heart_rate || data.heart_rate || null;
            const heartRateCard = document.getElementById('heart-rate-card');
            if (heartRate !== null) {
                const hrValue = Math.round(heartRate);
                document.getElementById('heart-rate').textContent = hrValue;
                updateHeartRateChart(heartRate);
                
                // Color coding for heart rate
                heartRateCard.classList.remove('normal', 'warning', 'critical');
                if (hrValue > 180) {
                    heartRateCard.classList.add('critical');
                } else if (hrValue > 150) {
                    heartRateCard.classList.add('warning');
                } else {
                    heartRateCard.classList.add('normal');
                }
            }

            // Battery
            const battery = data.battery_level || data.vitals?.battery || null;
            const batteryCard = document.getElementById('battery-card');
            if (battery !== null) {
                const batteryPercent = Math.round(battery);
                document.getElementById('battery-level').textContent = batteryPercent;
                const fill = document.getElementById('battery-fill');
                fill.style.width = batteryPercent + '%';
                
                // Color coding for battery
                batteryCard.classList.remove('normal', 'warning', 'critical');
                if (batteryPercent > 50) {
                    fill.className = 'battery-fill battery-high';
                    batteryCard.classList.add('normal');
                } else if (batteryPercent > 20) {
                    fill.className = 'battery-fill battery-medium';
                    batteryCard.classList.add('warning');
                } else {
                    fill.className = 'battery-fill battery-low';
                    batteryCard.classList.add('critical');
                }
            }

            // CO2 level (from environment or vitals)
            const co2 = data.environment?.co2 || data.vitals?.co2_level || data.co2_level || null;
            const co2Card = document.getElementById('co2-card');
            if (co2 !== null) {
                const co2Value = parseFloat(co2);
                document.getElementById('co2-level').textContent = co2Value.toFixed(1);
                
                // Color coding for CO2 (assuming normal is <5%, warning 5-10%, critical >10%)
                co2Card.classList.remove('normal', 'warning', 'critical');
                if (co2Value > 10) {
                    co2Card.classList.add('critical');
                } else if (co2Value > 5) {
                    co2Card.classList.add('warning');
                } else {
                    co2Card.classList.add('normal');
                }
            }

            // Motion status
            const isMoving = data.vitals?.is_moving !== false;
            const motionStatusEl = document.getElementById('motion-status');
            if (isMoving) {
                motionStatusEl.innerHTML = '<span class="status-indicator status-online"></span><span>W ruchu</span>';
            } else {
                motionStatusEl.innerHTML = '<span class="status-indicator status-warning"></span><span>Bezruch</span>';
            }

            // Man down status (PASS)
            const manDown = data.pass_status?.man_down || data.man_down || false;
            const manDownEl = document.getElementById('man-down-status');
            if (manDown) {
                manDownEl.innerHTML = '<span class="status-indicator status-danger"></span><span class="text-danger fw-bold">WYKRYTO BEZRUCH!</span>';
                manDownEl.classList.add('heartbeat-animation');
            } else {
                manDownEl.innerHTML = '<span class="status-indicator status-online"></span><span>Nie wykryto</span>';
                manDownEl.classList.remove('heartbeat-animation');
            }

            // Position
            const position = data.position;
            if (position && position.gps) {
                const [posLat, posLon] = position.gps;
                if (firefighterMarker) {
                    firefighterMarker.setLatLng([posLat, posLon]);
                } else {
                    firefighterMarker = L.marker([posLat, posLon], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background: #dc3545; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    map.setView([posLat, posLon], 18);
                }
                document.getElementById('position-coords').textContent = `${posLat.toFixed(6)}, ${posLon.toFixed(6)}`;
                document.getElementById('position-floor').textContent = position.floor !== undefined ? `Piętro ${position.floor}` : '--';
            }

            // Last update
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pl-PL');
        }

        function updateHeartRateChart(value) {
            const chart = heartRateChart;
            const now = new Date().toLocaleTimeString('pl-PL');
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(value);
            
            // Keep only last 20 points
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            chart.update('none');
        }

        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Brak aktywnych powiadomień</p>';
                return;
            }

            container.innerHTML = alerts.map(alert => {
                const severity = alert.severity || alert.type || 'warning';
                const alertClass = severity === 'critical' ? 'alert-critical' : 'alert-warning';
                const icon = severity === 'critical' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
                
                return `
                    <div class="alert-item ${alertClass}">
                        <i class="fas ${icon} me-2"></i>
                        <strong>${alert.type || 'Alert'}</strong>
                        <div class="small text-muted mt-1">${alert.message || alert.description || ''}</div>
                        <div class="small text-muted">${new Date(alert.timestamp || Date.now()).toLocaleString('pl-PL')}</div>
                    </div>
                `;
            }).join('');
        }

        // Local alerts tracking
        let localAlerts = [];

        function checkLocalAlerts(telemetry) {
            localAlerts = [];
            
            // Check high heart rate
            const heartRate = telemetry.vitals?.heart_rate || telemetry.heart_rate;
            if (heartRate && heartRate > 180) {
                localAlerts.push({
                    type: 'high_heart_rate',
                    severity: 'warning',
                    message: `Wysokie tętno: ${Math.round(heartRate)} bpm`,
                    timestamp: Date.now()
                });
            }

            // Check man down
            const manDown = telemetry.pass_status?.man_down || telemetry.man_down;
            if (manDown) {
                localAlerts.push({
                    type: 'man_down',
                    severity: 'critical',
                    message: 'Wykryto bezruch strażaka!',
                    timestamp: Date.now()
                });
            }

            // Check low battery
            const battery = telemetry.battery_level || telemetry.vitals?.battery;
            if (battery && battery < 20) {
                localAlerts.push({
                    type: 'low_battery',
                    severity: 'warning',
                    message: `Niski poziom baterii: ${Math.round(battery)}%`,
                    timestamp: Date.now()
                });
            }
        }

        // Fetch data
        async function fetchFirefighterData() {
            try {
                const [telemetryRes, alertsRes] = await Promise.all([
                    fetch(`${apiBaseUrl}firefighter/${firefighterId}/telemetry`),
                    fetch(`${apiBaseUrl}firefighter/${firefighterId}/alerts`)
                ]);

                if (telemetryRes.ok) {
                    const telemetry = await telemetryRes.json();
                    updateTelemetry(telemetry);
                    checkLocalAlerts(telemetry);
                }

                if (alertsRes.ok) {
                    const alertsData = await alertsRes.json();
                    const apiAlerts = alertsData.alerts || alertsData || [];
                    // Combine API alerts with local alerts
                    const allAlerts = [...apiAlerts, ...localAlerts];
                    updateAlerts(allAlerts);
                } else {
                    // If API fails, show only local alerts
                    updateAlerts(localAlerts);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                // Show local alerts even if API fails
                updateAlerts(localAlerts);
            }
        }

        // Initial fetch and periodic updates
        fetchFirefighterData();
        setInterval(fetchFirefighterData, 2000); // Update every 2 seconds
    </script>
</body>
</html>

